# Codebase Summary System Architecture

**Feature**: Pre-agent codebase summary system
**Cycle ID**: pre-agent-codebase-summary-system
**Author**: Architect Agent
**Created**: 2025-10-12
**Status**: Focus Phase - Architecture Design

---

## Executive Summary

The Codebase Summary System provides a pre-generated, comprehensive overview of the FORGE MCP Server codebase that is automatically loaded before any specialized agent invocation. This reduces token usage by 30-50% per agent session by eliminating redundant file reads and providing agents with instant access to architecture, component, and tool information.

**Key Benefits**:
- **Token Efficiency**: Reduces agent token usage by 30-50%
- **Faster Response**: Agents answer immediately from summary without file I/O
- **Consistency**: All agents work from same architectural understanding
- **Onboarding**: Serves double-duty as human developer documentation

---

## System Architecture

### High-Level Overview

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     FORGE MCP SERVER                         ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ User/Client    ‚îÇ         ‚îÇ  .forge/ Directory      ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ Calls          ‚îÇ         ‚îÇ                         ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ forge_invoke   ‚îÇ         ‚îÇ  ‚îú‚îÄ‚îÄ context.md         ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ _agent         ‚îÇ         ‚îÇ  ‚îú‚îÄ‚îÄ learnings.md       ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ  ‚îú‚îÄ‚îÄ cycles/            ‚îÇ    ‚îÇ
‚îÇ       ‚îÇ                     ‚îÇ  ‚îî‚îÄ‚îÄ codebase-summary.md ‚îÇ    ‚îÇ
‚îÇ       ‚îÇ                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ       ‚ñº                                ‚îÇ                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ     lib/tools/index.js                                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     forge_invoke_agent()                              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     1. Load codebase-summary.md                       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     2. Parse and add to context                       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ     3. Invoke specialized agent                       ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                     ‚îÇ                                         ‚îÇ
‚îÇ       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                     ‚îÇ
‚îÇ       ‚îÇ  Specialized Agent             ‚îÇ                     ‚îÇ
‚îÇ       ‚îÇ  (Architect/Developer/etc.)    ‚îÇ                     ‚îÇ
‚îÇ       ‚îÇ                                 ‚îÇ                     ‚îÇ
‚îÇ       ‚îÇ  Uses codebase                 ‚îÇ                     ‚îÇ
‚îÇ       ‚îÇ  SummaryContext to answer      ‚îÇ                     ‚îÇ
‚îÇ       ‚îÇ  without reading files         ‚îÇ                     ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

                      ‚ñ≤
                      ‚îÇ
                      ‚îÇ Generated by
                      ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  scripts/               ‚îÇ
         ‚îÇ  generate-codebase-     ‚îÇ
         ‚îÇ  summary.js             ‚îÇ
         ‚îÇ                         ‚îÇ
         ‚îÇ  Analyzes codebase      ‚îÇ
         ‚îÇ  Generates markdown     ‚îÇ
         ‚îÇ  Validates size/format  ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Component Design

### 1. Generator Script (`scripts/generate-codebase-summary.js`)

**Purpose**: Analyze FORGE codebase and generate comprehensive markdown summary

**Architecture**:
```javascript
class CodebaseSummaryGenerator {
  constructor(projectRoot) {
    this.projectRoot = projectRoot;
    this.tokenBudget = 5000;
    this.sections = [];
  }

  async generate() {
    // 1. Analyze codebase
    const analysis = await this.analyzeCodebase();

    // 2. Generate each section
    this.sections.push(await this.generateArchitectureSection(analysis));
    this.sections.push(await this.generateComponentsSection(analysis));
    this.sections.push(await this.generateToolsSection(analysis));
    this.sections.push(await this.generateFileStructureSection(analysis));
    this.sections.push(await this.generateWorkflowSection(analysis));
    this.sections.push(await this.generateAgentPatternsSection(analysis));

    // 3. Validate token count
    const summary = this.assembleSummary();
    this.validateTokenCount(summary);

    // 4. Write to .forge/
    await this.writeSummary(summary);

    return summary;
  }

  async analyzeCodebase() {
    return {
      entryPoint: await this.analyzeFile('server.js'),
      core: await this.analyzeDirectory('lib/core/'),
      tools: await this.analyzeDirectory('lib/tools/'),
      resources: await this.analyzeDirectory('lib/resources/'),
      agents: await this.analyzeDirectory('templates/agents/'),
      package: await this.analyzePackageJson()
    };
  }
}
```

**Key Methods**:
- `analyzeCodebase()` - Parse all relevant source files
- `generateArchitectureSection()` - Create high-level architecture overview
- `generateComponentsSection()` - Document lib/core/ components
- `generateToolsSection()` - Extract all MCP tools with schemas
- `generateFileStructureSection()` - Map directory organization
- `generateWorkflowSection()` - Document development practices
- `generateAgentPatternsSection()` - Explain agent invocation
- `validateTokenCount()` - Ensure under 5000 tokens
- `writeSummary()` - Write to `.forge/codebase-summary.md`

**Token Budget Allocation**:
```
Total: 5000 tokens

Section Distribution:
- Header & Metadata:        200 tokens (4%)
- Architecture Overview:   1000 tokens (20%)
- Core Components:         1200 tokens (24%)
- MCP Tools Reference:     1000 tokens (20%)
- File Structure:           600 tokens (12%)
- Development Workflow:     500 tokens (10%)
- Agent Integration:        500 tokens (10%)
```

---

### 2. Validation Script (`scripts/validate-summary.js`)

**Purpose**: Ensure summary is complete, accurate, and within token limits

**Architecture**:
```javascript
class SummaryValidator {
  constructor(summaryPath) {
    this.summaryPath = summaryPath;
    this.errors = [];
    this.warnings = [];
  }

  async validate() {
    // 1. File exists
    await this.checkFileExists();

    // 2. Token count
    await this.validateTokenCount();

    // 3. Required sections present
    await this.validateSections();

    // 4. Freshness check
    await this.validateFreshness();

    // 5. Format validation
    await this.validateMarkdown();

    return {
      valid: this.errors.length === 0,
      errors: this.errors,
      warnings: this.warnings
    };
  }
}
```

**Validation Rules**:
- ‚úÖ File exists at `.forge/codebase-summary.md`
- ‚úÖ Token count ‚â§ 5000
- ‚úÖ All 6 required sections present
- ‚úÖ Last updated within 7 days (warning only)
- ‚úÖ Valid markdown syntax
- ‚úÖ No sensitive data (API keys, passwords)

---

### 3. Agent Integration (`lib/tools/index.js` - forge_invoke_agent modification)

**Current Implementation**:
```javascript
forge_invoke_agent: {
  description: 'Invoke a specific FORGE agent for a task',
  schema: {
    type: 'object',
    properties: {
      agentType: { type: 'string', enum: [...] },
      task: { type: 'string' },
      cycleId: { type: 'string' },
      context: { type: 'object' }
    },
    required: ['agentType', 'task']
  },
  handler: async (args) => {
    // ... existing implementation
  }
}
```

**Modified Implementation**:
```javascript
forge_invoke_agent: {
  // ... same schema ...

  handler: async (args) => {
    const { agentType, task, cycleId, context = {} } = args;

    // NEW: Load codebase summary
    const codebaseSummary = await loadCodebaseSummary();

    // NEW: Add to context
    const enrichedContext = {
      ...context,
      codebaseSummary: codebaseSummary || null,
      summaryLoaded: codebaseSummary !== null
    };

    // Existing cycle loading
    let cycleContext = null;
    if (cycleId) {
      cycleContext = await loadCycleContext(cycleId);
    }

    // Build agent prompt with summary
    const agentPrompt = buildAgentPrompt(
      agentType,
      task,
      cycleContext,
      enrichedContext  // Now includes summary
    );

    return agentPrompt;
  }
}

// NEW Helper function
async function loadCodebaseSummary() {
  try {
    const summaryPath = path.join(process.cwd(), '.forge', 'codebase-summary.md');

    // Check if file exists
    if (!fs.existsSync(summaryPath)) {
      console.warn('‚ö†Ô∏è  Codebase summary not found. Run: npm run generate:summary');
      return null;
    }

    // Read and return
    const summary = await fs.promises.readFile(summaryPath, 'utf-8');

    // Optional: Validate freshness
    const stats = await fs.promises.stat(summaryPath);
    const age = Date.now() - stats.mtimeMs;
    const sevenDays = 7 * 24 * 60 * 60 * 1000;

    if (age > sevenDays) {
      console.warn('‚ö†Ô∏è  Codebase summary is >7 days old. Consider regenerating.');
    }

    return summary;

  } catch (error) {
    console.error('Error loading codebase summary:', error.message);
    return null;
  }
}
```

**Backward Compatibility**:
- ‚úÖ Summary loading is optional - if missing, agents work normally
- ‚úÖ No breaking changes to `forge_invoke_agent` API
- ‚úÖ Existing agents unaffected if they don't use summary
- ‚úÖ Gradual adoption - can test with one agent before enabling for all

---

## Data Flow

### Summary Generation Flow

```
[Developer runs: npm run generate:summary]
                ‚Üì
[scripts/generate-codebase-summary.js executes]
                ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. ANALYZE PHASE                              ‚îÇ
‚îÇ    - Read server.js                           ‚îÇ
‚îÇ    - Parse lib/core/*.js                      ‚îÇ
‚îÇ    - Parse lib/tools/index.js                 ‚îÇ
‚îÇ    - Parse lib/resources/index.js             ‚îÇ
‚îÇ    - Read templates/agents/*.md               ‚îÇ
‚îÇ    - Read package.json                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. GENERATION PHASE                           ‚îÇ
‚îÇ    - Build architecture ASCII diagram         ‚îÇ
‚îÇ    - Extract component descriptions           ‚îÇ
‚îÇ    - Parse MCP tool schemas                   ‚îÇ
‚îÇ    - Map file structure                       ‚îÇ
‚îÇ    - Document workflows from CLAUDE.md        ‚îÇ
‚îÇ    - Explain agent patterns                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. VALIDATION PHASE                           ‚îÇ
‚îÇ    - Count tokens (must be ‚â§5000)             ‚îÇ
‚îÇ    - Check all sections present               ‚îÇ
‚îÇ    - Validate markdown syntax                 ‚îÇ
‚îÇ    - Scan for sensitive data                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. WRITE PHASE                                ‚îÇ
‚îÇ    - Write to .forge/codebase-summary.md      ‚îÇ
‚îÇ    - Set file permissions (644)               ‚îÇ
‚îÇ    - Output success message                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚Üì
[.forge/codebase-summary.md created]
[Token count: XXXX/5000]
[‚úì Ready for agent use]
```

### Agent Invocation Flow

```
[User calls forge_invoke_agent('architect', 'Design auth system')]
                ‚Üì
[lib/tools/index.js: forge_invoke_agent handler]
                ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. PRE-LOAD PHASE                             ‚îÇ
‚îÇ    - Check if .forge/codebase-summary.md exists‚îÇ
‚îÇ    - If exists: Read file synchronously       ‚îÇ
‚îÇ    - If missing: Log warning, continue        ‚îÇ
‚îÇ    - Check freshness (>7 days = warning)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. CONTEXT ENRICHMENT                         ‚îÇ
‚îÇ    - Add codebaseSummary to context object    ‚îÇ
‚îÇ    - Add summaryLoaded boolean flag           ‚îÇ
‚îÇ    - Merge with user-provided context         ‚îÇ
‚îÇ    - Load cycle context if cycleId provided   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. AGENT PROMPT BUILDING                      ‚îÇ
‚îÇ    - Load agent template                      ‚îÇ
‚îÇ    - Inject codebase summary into prompt      ‚îÇ
‚îÇ    - Add task and cycle context               ‚îÇ
‚îÇ    - Format for agent consumption             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. AGENT EXECUTION                            ‚îÇ
‚îÇ    - Agent receives enriched context          ‚îÇ
‚îÇ    - Agent references summary for answers     ‚îÇ
‚îÇ    - Agent avoids redundant file reads        ‚îÇ
‚îÇ    - Agent completes task                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Summary Document Structure

### File Location
```
.forge/codebase-summary.md
```

### Document Template

```markdown
# FORGE MCP Server - Codebase Summary

**Version**: 1.0.0
**Generated**: 2025-10-12T18:30:00Z
**Codebase Version**: git commit hash
**Last Updated**: YYYY-MM-DD
**Token Count**: XXXX/5000

---

## 1. Architecture Overview (1000 tokens)

### System Purpose
[Brief description of FORGE MCP Server]

### High-Level Architecture
[ASCII diagram showing major components]

### Data Flow
[Request/response flow through the system]

### Key Design Patterns
[Patterns used: MCP protocol, State Manager, Resource-based templates]

---

## 2. Core Components (1200 tokens)

### 2.1 MCP Server (`lib/core/mcp-server.js`)
- Purpose: Main MCP protocol handler
- Key Methods: handleRequest(), handleNotification()
- Dependencies: Transport layer, StateManager
- Integration Points: All tools and resources

### 2.2 State Manager (`lib/core/state-manager.js`)
- Purpose: Persistent state in .forge/ directory
- Key Methods: loadContext(), saveCycle(), getCycle()
- File Structure: context.yaml, cycles/, learnings.yaml
- Data Models: Context, Cycle, Learning

### 2.3 Standards Detector (`lib/core/standards-detector.js`)
- Purpose: Detect project standards automatically
- Detection: Linting, testing, CI/CD, git hooks
- Integration: Used during forge_init_project
- Output: standards-report.json

### 2.4 Docs Manager (`lib/core/docs-manager.js`)
- Purpose: Auto-generate documentation
- Capabilities: PRD, test plans, architecture docs
- Integration: forge_new_cycle, forge_generate_docs
- Templates: Uses templates/ directory

### 2.5 Local LLM Orchestrator (`lib/core/local-llm-orchestrator.js`)
- Purpose: Delegate trivial tasks to local models
- Integration: Ollama support
- Use Cases: Template generation, task breakdown
- Configuration: Optional, disabled by default

### 2.6 Command Safety (`lib/core/command-safety.js`)
- Purpose: Protect against destructive commands
- Patterns: 30+ destructive patterns detected
- Workflow: Validate ‚Üí Warn ‚Üí Approve ‚Üí Execute
- Integration: Referenced by all agents

---

## 3. MCP Tools Reference (1000 tokens)

### Project Management
- `forge_init_project` - Initialize FORGE in project
- `forge_analyze_project` - Analyze project structure

### Cycle Management
- `forge_new_cycle` - Create development cycle
- `forge_cycle_status` - View cycle progress
- `forge_complete_cycle` - Complete and archive cycle

### Phase Control
- `forge_phase_advance` - Advance to next phase
- `forge_phase_update` - Update phase progress
- `forge_checkpoint` - Validate phase compliance

### Agent Invocation
- `forge_invoke_agent` - Invoke specialized agent
- `forge_guide_next` - Get next action recommendations

### Documentation
- `forge_generate_docs` - Generate cycle documentation
- `forge_decompose_prd` - Analyze and decompose PRD

### Learning & Retrospectives
- `forge_add_learning` - Capture project insight
- `forge_retrospective` - Generate retrospective

### Local LLM
- `forge_local_llm_status` - Check Ollama status
- `forge_local_llm_config` - Configure delegation
- `forge_delegate_task` - Manually delegate task

### Task Completion
- `forge_complete_task` - Mark phase task complete

---

## 4. File Structure (600 tokens)

```
forge-mcp/
‚îú‚îÄ‚îÄ server.js                 # Entry point
‚îú‚îÄ‚îÄ package.json              # Dependencies and scripts
‚îú‚îÄ‚îÄ .eslintrc.js              # Linting configuration
‚îÇ
‚îú‚îÄ‚îÄ lib/                      # Core implementation
‚îÇ   ‚îú‚îÄ‚îÄ core/                 # Core components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mcp-server.js     # MCP protocol handler
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ state-manager.js  # Persistent state
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ standards-detector.js # Standards detection
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ docs-manager.js   # Documentation generation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ local-llm-orchestrator.js # LLM delegation
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ command-safety.js # Command validation
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ tools/                # MCP tool implementations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.js          # All 18 FORGE tools
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ resources/            # MCP resource providers
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.js          # Templates, cycles, context
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ transport/            # Transport layers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stdio.js          # Standard I/O (default)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sse.js            # Server-Sent Events
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ dashboard/            # Web dashboard (optional)
‚îÇ       ‚îú‚îÄ‚îÄ dashboard-handler.js
‚îÇ       ‚îî‚îÄ‚îÄ public/
‚îÇ
‚îú‚îÄ‚îÄ templates/                # Agent and document templates
‚îÇ   ‚îú‚îÄ‚îÄ agents/               # 7 specialized agent definitions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ architect.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ developer.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tester.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ devops.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ security.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ documentation.md
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ reviewer.md
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ cycle.md              # Cycle template
‚îÇ   ‚îú‚îÄ‚îÄ prd.md                # PRD template
‚îÇ   ‚îî‚îÄ‚îÄ retrospective.md      # Retrospective template
‚îÇ
‚îú‚îÄ‚îÄ .claude-plugin/           # Claude Code plugin
‚îÇ   ‚îú‚îÄ‚îÄ plugin.json           # Plugin manifest
‚îÇ   ‚îú‚îÄ‚îÄ commands/             # Slash commands
‚îÇ   ‚îú‚îÄ‚îÄ agents/               # Agent definitions
‚îÇ   ‚îî‚îÄ‚îÄ hooks/                # Workflow hooks
‚îÇ
‚îú‚îÄ‚îÄ docs/                     # Documentation
‚îÇ   ‚îú‚îÄ‚îÄ prd/                  # Product requirements
‚îÇ   ‚îú‚îÄ‚îÄ architecture/         # Architecture docs
‚îÇ   ‚îú‚îÄ‚îÄ testing/              # Test plans
‚îÇ   ‚îú‚îÄ‚îÄ security/             # Security docs
‚îÇ   ‚îî‚îÄ‚îÄ retrospectives/       # Retrospectives
‚îÇ
‚îî‚îÄ‚îÄ test/                     # Test suite
    ‚îú‚îÄ‚îÄ basic-test.js
    ‚îú‚îÄ‚îÄ command-safety-test.js
    ‚îî‚îÄ‚îÄ ...
```

---

## 5. Development Workflow (500 tokens)

### Git Workflow
- Frequent commits after completing tasks
- Regular pushes (at least daily)
- Descriptive commit messages (focus on "why")
- PR-based development

### Testing Approach
- Test files in `test/` directory
- Run with: `npm test` or `node test/specific-test.js`
- Focus on MCP tool testing
- Standards enforcement demos

### Linting & Code Quality
- ESLint configuration in `.eslintrc.js`
- Run: `npm run lint`
- Auto-fix: `npm run lint:fix`
- Pre-commit hooks for validation

### FORGE Phases
1. **Focus**: Requirements gathering, architecture design
2. **Orchestrate**: Task breakdown, dependency planning
3. **Refine**: Implementation with TDD
4. **Generate**: Build and deployment prep
5. **Evaluate**: Metrics and retrospective

---

## 6. Agent Integration Patterns (500 tokens)

### Agent Types
- üü¶ Architect - System design
- üü® Developer - Implementation
- üü™ Tester - QA strategy
- üü© DevOps - Infrastructure
- üü• Security - Security analysis
- üü´ Documentation - Technical writing
- üüß Reviewer - Code review

### Invocation Pattern
```javascript
forge_invoke_agent(
  agentType,    // 'architect', 'developer', etc.
  cycleId,      // Optional: Link to development cycle
  task          // Specific task description
)
```

### Context Loading
Agents receive:
- Agent template from `templates/agents/*.md`
- Cycle context if cycleId provided
- **Codebase summary** (this document)
- User-provided context object

### Agent Workflow
1. Agent loaded with specialized template
2. Codebase summary auto-injected
3. Cycle context added if applicable
4. Agent analyzes task with full context
5. Agent provides specialized guidance
6. No redundant file reads needed

---

**End of Summary**
```

---

## Integration Points

### 1. Summary Loading in forge_invoke_agent

**Integration Location**: `lib/tools/index.js` lines ~550-650 (forge_invoke_agent handler)

**Code Changes**:
```javascript
// Add this helper function at top of file
const fs = require('fs').promises;
const path = require('path');

async function loadCodebaseSummary() {
  try {
    const summaryPath = path.join(process.cwd(), '.forge', 'codebase-summary.md');

    // Check existence
    await fs.access(summaryPath);

    // Read file
    const summary = await fs.readFile(summaryPath, 'utf-8');

    // Check freshness (warn if >7 days old)
    const stats = await fs.stat(summaryPath);
    const ageMs = Date.now() - stats.mtimeMs;
    const sevenDaysMs = 7 * 24 * 60 * 60 * 1000;

    if (ageMs > sevenDaysMs) {
      console.warn('‚ö†Ô∏è  Codebase summary is >7 days old. Run: npm run generate:summary');
    }

    return summary;
  } catch (error) {
    // File doesn't exist or can't be read - that's ok
    if (error.code === 'ENOENT') {
      console.warn('üí° Codebase summary not found. Run: npm run generate:summary');
    }
    return null;
  }
}

// Modify forge_invoke_agent handler
forge_invoke_agent: {
  // ... schema stays the same ...

  handler: async (args) => {
    const { agentType, task, cycleId, context = {} } = args;

    // Load codebase summary (NEW)
    const codebaseSummary = await loadCodebaseSummary();

    // Enrich context (NEW)
    const enrichedContext = {
      ...context,
      codebaseSummary: codebaseSummary || null,
      summaryLoaded: !!codebaseSummary
    };

    // Rest of existing implementation...
    // (cycle loading, agent template loading, etc.)

    // When building the agent prompt, include summary
    let prompt = `ü§ñ **${agentIcon} ${agentName} Auto-Activated**\n\n`;

    // Add summary if available (NEW)
    if (codebaseSummary) {
      prompt += `**üìö CODEBASE SUMMARY:**\n${codebaseSummary}\n\n`;
      prompt += `---\n\n`;
    }

    // Rest of prompt building...
    // (existing agent context, task, etc.)
  }
}
```

---

### 2. Context Object Structure

**Before (Current)**:
```javascript
{
  autoInvoked: boolean,
  phase: string,
  timestamp: string,
  // User-provided context
  ...context
}
```

**After (With Summary)**:
```javascript
{
  autoInvoked: boolean,
  phase: string,
  timestamp: string,
  codebaseSummary: string | null,  // NEW
  summaryLoaded: boolean,           // NEW
  // User-provided context
  ...context
}
```

---

## Technical Decisions

### 1. Synchronous vs Asynchronous Loading

**Decision**: Asynchronous loading with async/await

**Rationale**:
- File I/O is async by nature in Node.js
- Using async/await keeps code clean and readable
- Still fast enough (<100ms) for user experience
- Allows proper error handling
- forge_invoke_agent handler is already async

**Performance Impact**: Negligible - single 5KB file read takes <10ms

---

### 2. Caching Strategy

**Decision**: No caching in Phase 1, optional in-memory cache in Phase 2

**Phase 1 (MVP)**:
- Load summary fresh on each agent invocation
- Simple, predictable behavior
- No cache invalidation complexity
- Performance is acceptable (5KB read is fast)

**Phase 2 (Optional Enhancement)**:
```javascript
// Simple in-memory cache
let summaryCache = null;
let cacheTimestamp = 0;
const CACHE_TTL = 60 * 1000; // 1 minute

async function loadCodebaseSummary() {
  const now = Date.now();

  // Return cached if fresh
  if (summaryCache && (now - cacheTimestamp < CACHE_TTL)) {
    return summaryCache;
  }

  // Load and cache
  summaryCache = await fs.readFile(...);
  cacheTimestamp = now;

  return summaryCache;
}
```

**Rationale for no-cache in Phase 1**:
- Simpler implementation
- Easier debugging
- Always up-to-date
- Negligible performance difference

---

### 3. Error Handling Strategy

**Decision**: Graceful degradation - agents work without summary

**Implementation**:
```javascript
// Summary loading never throws
// Always returns null on any error
// Agents check if summary exists before using

if (!validation.safe) {
  // STOP - Present warning to human
  const prompt = safety.generateConfirmationPrompt(command, validation);
  console.log(prompt);

  // Wait for explicit user approval
  // DO NOT execute until user confirms
  return;
}
```

**Error Scenarios**:
1. **File doesn't exist**: Log warning, continue without summary
2. **File unreadable**: Log error, continue without summary
3. **File corrupted**: Log error, continue without summary
4. **File too old**: Log warning, use summary anyway

**Rationale**:
- No breaking changes to existing agents
- System remains functional even if summary fails
- Encourages generation but doesn't require it
- Developer-friendly warnings guide to resolution

---

### 4. Version Tracking

**Decision**: Embedded metadata in summary document

**Implementation**:
```markdown
---
version: 1.0.0
generated: 2025-10-12T18:30:00Z
codebaseVersion: abc123def  # git commit hash
lastUpdated: 2025-10-12
tokenCount: 4850/5000
---
```

**Validation**:
- Compare `generated` timestamp to current date
- Warn if >7 days old
- Optional: Compare `codebaseVersion` to current git HEAD
- Track `tokenCount` to ensure under budget

---

## Implementation Plan

### Phase 1: Foundation (Current Focus Phase)
- ‚úÖ PRD complete
- ‚úÖ Architecture design complete
- ‚è≥ Test scenarios (next step)
- ‚è≥ Advance to Orchestrate phase

### Phase 2: Core Development (Orchestrate ‚Üí Refine)
1. Implement `scripts/generate-codebase-summary.js`
2. Implement `scripts/validate-summary.js`
3. Generate initial summary
4. Modify `lib/tools/index.js` - `forge_invoke_agent`
5. Test with single agent type
6. Test with all 7 agent types
7. Code review

### Phase 3: Documentation & Testing (Generate)
1. Document summary generation process
2. Add to CLAUDE.md
3. Add to README.md
4. Create test suite
5. Update agent templates with usage guidance

### Phase 4: Validation (Evaluate)
1. Measure token usage reduction
2. Test agent self-sufficiency
3. Validate summary accuracy
4. Gather feedback
5. Retrospective

---

## Success Criteria

### Functional Requirements Met
- ‚úÖ Summary document exists at `.forge/codebase-summary.md`
- ‚úÖ All 6 sections present and complete
- ‚úÖ Token count under 5000
- ‚úÖ Auto-loads before agent invocation
- ‚úÖ Works with all 7 agent types

### Non-Functional Requirements Met
- ‚úÖ Load time <100ms
- ‚úÖ No sensitive data in summary
- ‚úÖ Markdown format valid
- ‚úÖ Backward compatible

### KPIs Achieved
- ‚úÖ 30-50% token usage reduction per agent invocation
- ‚úÖ Zero duplicate file reads of core components
- ‚úÖ 80%+ of architecture questions answered from summary alone

---

## Risks & Mitigations

Documented in PRD section "Risks and Mitigation" - all identified risks have clear mitigation strategies.

---

## Next Steps

1. **Complete Focus Phase**:
   - Define comprehensive test scenarios
   - Validate all Focus phase requirements met

2. **Advance to Orchestrate**:
   - Break down implementation into tasks
   - Estimate effort for each component
   - Define dependencies between tasks

3. **Begin Development (Refine)**:
   - Start with generator script
   - Generate initial summary
   - Integrate with forge_invoke_agent
   - Test with agents

---

**Document Status**: Complete - Ready for Review
**Next Phase Action**: Define test scenarios with Tester Agent
**Architecture Sign-off**: Pending Architect Agent review
